var learningjs=function(t){"use strict";function e(t,e){if(n){for(var r="",a=0;2*e>a;a++)r+=" ";console.log(r,t)}}var r;if("undefined"==typeof _&&"function"==typeof require)var a=require("underscore");if("undefined"!=typeof _)r=_;else{if("undefined"==typeof a)throw"underscore.js isn't found!";r=a}var n=!0,i=function(){},n=!1;i.prototype={train:function(t,e){var a=this.mostCommon(t.targets);e({model:this._c45(t.data,t.targets,t.l_featuresIndex,t.featureNames,t.featuresType,a),classify:function(e){var n=this.model;if("undefined"==typeof n)return"null";for(;"result"!=n.type;){var i;if("feature_real"===n.type){var o=n.name,u=parseFloat(e[t.feature_name2id[o]]);i=u<=n.cut?n.vals[1]:n.vals[0]}else{var s=n.name,u=e[t.feature_name2id[s]];i=r.detect(n.vals,function(t){return t.name==u})}if("undefined"==typeof i)return a;n=i.child}return n.val},calcAccuracy:function(t,e,r){for(var a=t.length,n=0,i=0;i<t.length;i++){var o=this.classify(t[i]),u=e[i];o===u&&n++}a>0?r(n/a,n,a):r(0)}},void 0)},_c45:function(t,a,n,i,o,u){var s;if(0==a.length)return e("==no data",0),{type:"result",val:u,name:u,alias:u+this.randomTag()};if(1==a.length)return e("==end node "+a[0],0),{type:"result",val:a[0],name:a[0],alias:a[0]+this.randomTag()};if(0==i.length){e("==returning the most dominate feature",0);var l=this.mostCommon(a);return{type:"result",val:l,name:l,alias:l+this.randomTag()}}var f=this.maxGain(t,a,n,i,o),h=f.feature_id,c=f.feature_name,g=r.without(n,h),d=r.without(i,c);if("real"===o[c]){s={name:c,id:h,alias:c+this.randomTag()},s.type="feature_real",s.cut=f.cut,s.vals=[];var v=this.filterByCutGreater(t,a,f.cut,h),p={name:f.cut.toString(),alias:">"+f.cut.toString()+this.randomTag(),type:"feature_value"};p.child=this._c45(v[0],v[1],g,d,o,u),s.vals.push(p);var m=this.filterByCutLessEqual(t,a,f.cut,h),y={name:f.cut.toString(),alias:"<="+f.cut.toString()+this.randomTag(),type:"feature_value"};y.child=this._c45(m[0],m[1],g,d,o,u),s.vals.push(y)}else{var _=r.unique(this.getCol(t,h));s={name:c,alias:c+this.randomTag()},s.type="feature_category",s.vals=[];for(var T=0;T<_.length;T++){var w=this.filterByValue(t,a,h,_[T]),b={name:_[T],alias:_[T]+this.randomTag(),type:"feature_value"};b.child=this._c45(w[0],w[1],g,d,o,u),s.vals.push(b)}}return s},addEdges:function(t,e,a,n){var i=this;if("feature_real"==t.type||"feature_category"==t.type)return r.each(t.vals,function(r){n.push(["val:"+r.alias+"</span>",t.alias+"","node"]),n=i.addEdges(r,e,a,n)}),n;if("feature_value"==t.type){if("result"!=t.child.type)n.push([t.child.alias+"","val:"+t.alias+"</span>","value"]),n=this.addEdges(t.child,e,a,n);else{var o="black";if(t.child.name in a)o=a[t.child.name];else{var u=Object.keys(a).length;o=u>=e.length?"black":e[u],a[t.child.name]=o}n.push(['<span style="color:'+o+';font-weight:bold;">'+t.child.alias+"</span>","val:"+t.alias+"</span>","value"])}return n}return n},drawGraph:function(t,e,a){if("undefined"==typeof google)return void a("google visualization APIs are not defined");var n=new Array,i=["red","blue","green","yellow","black","fuchsia","gold","indigo","lime","mintcream","navy","olive","salmon","skyblue"],o={};n=this.addEdges(t.model,i,o,n).reverse(),window.g=n;var u=google.visualization.arrayToDataTable(n.concat(n)),s=new google.visualization.OrgChart(document.getElementById(e));google.visualization.events.addListener(s,"ready",function(){r.each($(".google-visualization-orgchart-node"),function(t){var e=$(t).html();if(e){var r=e.replace(/_r[0-9]+/,"");r=r.replace(/val:/,'<span style="color:olivedrab;">'),$(t).html(r)}})}),s.draw(u,{allowHtml:!0}),a()},getCol:function(t,e){for(var r=[],a=0;a<t.length;a++)r.push(t[a][e]);return r},filterByCutLessEqual:function(t,e,r,a){var n=[],i=[];t.length!=e.length&&console.log("ERRROR: difft dimensions");for(var o=0;o<t.length;o++)parseFloat(t[o][a])<=r&&(n.push(t[o]),i.push(e[o]));return[n,i]},filterByCutGreater:function(t,e,r,a){var n=[],i=[];t.length!=e.length&&console.log("ERRROR: difft dimensions");for(var o=0;o<t.length;o++)parseFloat(t[o][a])>r&&(n.push(t[o]),i.push(e[o]));return[n,i]},filterByValue:function(t,e,r,a){for(var n=[],i=[],o=0;o<t.length;o++)t[o][r]===a&&(n.push(t[o]),i.push(e[o]));return[n,i]},gain:function(t,e,a,n,i){t.length!=e.length&&console.log("ERRROR: difft dimensions");var o=this.entropy(e),u=r.unique(this.getCol(t,a));if("real"===i[n]){for(var s=[],l=0;l<u.length;l++){var f=parseFloat(u[l]),h=o-this.conditionalEntropy(t,e,a,f);s.push({feature_id:a,feature_name:n,gain:h,cut:f})}var c=r.max(s,function(t){return t.gain});return c}for(var g=t.length,d=[],l=0;l<u.length;l++){var v=this.filterByValue(t,e,a,u[l]);d.push(v[0].length/g*this.entropy(v[1]))}var p=r(d).reduce(function(t,e){return t+e},0);return{feature_id:a,feature_name:n,gain:o-p,cut:0}},entropy:function(t){var e=this,a=r.unique(t),n=a.map(function(r){return e.prob(r,t)}),i=n.map(function(t){return-t*e.log2(t)});return i.reduce(function(t,e){return t+e},0)},conditionalEntropy:function(t,e,r,a){var n=this.filterByCutLessEqual(t,e,a,r),i=this.filterByCutGreater(t,e,a,r),o=t.length;return n[0].length/o*this.entropy(n[1])+i[0].length/o*this.entropy(n[1])},maxGain:function(t,e,a,n,i){for(var o=[],u=0;u<a.length;u++)o.push(this.gain(t,e,a[u],n[u],i));return r.max(o,function(t){return t.gain})},prob:function(t,e){var a=r.filter(e,function(e){return e===t}).length,n=e.length;return a/n},log2:function(t){return Math.log(t)/Math.log(2)},mostCommon:function(t){var e=this;return r.sortBy(t,function(r){return e.count(r,t)}).reverse()[1]},count:function(t,e){return r.filter(e,function(e){return e===t}).length},randomTag:function(){return"_r"+Math.round(1e6*Math.random()).toString()}};var o=function(){};o.prototype={train:function(t,e){e({that:this,thetas:this.optimize(t),classify:function(e){for(var r=this.that.compThetaXProduct(this.thetas[t.l_targets[0]],e,t.nfeatures),a=t.l_targets[0],n=1;n<t.ntargets;n++){var i=t.l_targets[n],o=this.that.compThetaXProduct(this.thetas[i],e,t.nfeatures);o>r&&(r=o,a=i)}return a},calcAccuracy:function(t,e,r){for(var a=t.length,n=0,i=0;i<t.length;i++){var o=this.classify(t[i]),u=e[i];o===u&&n++}a>0?r(n/a,n,a):r(0)}},void 0)},printThetas:function(t,e,r,a){for(var n=0;e>n;n++){console.log(r[n]);for(var i=0;a>i;i++)process.stdout.write(t[r[n]][i]+" ");console.log(" ")}},optimize:function(t){"optimizer"in t||(t.optimizer="sgd"),"learning_rate"in t||(t.learning_rate=.005),"l2_weight"in t||(t.l2_weight=1e-6),"iterations"in t||(t.iterations=50);for(var e={},r=0;r<t.ntargets;r++){for(var a=[],n=0;n<t.nfeatures;n++)a.push(0);e[t.l_targets[r]]=a}for(var r=0;r<t.iterations;r++)if("sgd"===t.optimizer)this.sgd_once(e,t.data,t.nfeatures,t.targets,t.l_targets,t.ntargets,t.learning_rate,t.l2_weight);else{if("gd"!==t.optimizer){console.log("unrecognized optimizer:"+t.optimizer);break}this.gd_batch(e,t.data,t.nfeatures,t.targets,t.l_targets,t.ntargets,t.learning_rate,t.l2_weight)}return e},gd_batch:function(t,e,r,a,n,i,o,u){for(var s=0;i>s;s++){for(var l=[],f=0;r>f;f++)l.push(0);for(var h=n[s],c=0;c<e.length;c++){var g,d=[];d.push(this.compThetaXProduct(t[n[0]],e[c],r)),0==s&&(g=d[0]);for(var v=d[0],p=1;i>p;p++){var m=this.compThetaXProduct(t[n[p]],e[c],r);d[p]=m,s==p&&(g=m),m>v&&(v=m)}for(var y=0,p=0;i>p;p++)y+=Math.exp(d[p]-v);for(var _=Math.exp(g-v)/y,f=0;r>f;f++)l[f]+=h===a[c]?(1-_)*e[c][f]:(0-_)*e[c][f]}for(var T=t[h],f=0;r>f;f++)T[f]+=o*l[f]-2*e.length*u*T[f]}},sgd_once:function(t,e,r,a,n,i,o,u){for(var s=0;s<e.length;s++){var l=[];l.push(this.compThetaXProduct(t[n[0]],e[s],r));for(var f=l[0],h=1;i>h;h++){var c=this.compThetaXProduct(t[n[h]],e[s],r);l[h]=c,c>f&&(f=c)}for(var g=0,h=0;i>h;h++)g+=Math.exp(l[h]-f);for(var h=0;i>h;h++)for(var d=Math.exp(l[h]-f)/g,v=n[h],p=t[v],m=0;r>m;m++)p[m]+=v===a[s]?o*(1-d)*e[s][m]-2*u*p[m]:o*(0-d)*e[s][m]-2*u*p[m]}},compThetaXProduct:function(t,e,r){for(var a=0,n=0;r>n;n++)a+=t[n]*e[n];return a}};var t=t||{};return t.logistic=o,t.tree=i,t}("undefined"!=typeof module&&module.exports);